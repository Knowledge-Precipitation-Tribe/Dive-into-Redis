# 规避全量复制

全量复制是一个非常消耗资源的操作，前面做了具体说明。因此如何规 避全量复制是需要重点关注的运维点。下面我们对需要进行全量复制的场景逐个分析：

1. **第一次建立复制：**由于是第一次建立复制，从节点不包含任何主节点数据，因此必须进行全量复制才能完成数据同步。对于这种情况全量复制无法避免。当对数据量较大且流量较高的主节点添加从节点时，建议在低峰时进行操作，或者尽量规避使用大数据量的Redis节点。
2. **节点运行ID不匹配：**当主从复制关系建立后，从节点会保存主节点的运行ID，如果此时主节点因故障重启，那么它的运行ID会改变，从节点发现主节点运行ID不匹配时，会认为自己复制的是一个新的主节点从而进行全量复制。对于这种情况应该从架构上规避，比如提供故障转移功能。当主节点发生故障后，手动提升从节点为主节点或者采用支持自动故障转移的哨兵或集群方案。
3. **复制积压缓冲区不足：**当主从节点网络中断后，从节点再次连上主节点时会发送psync{offset}{runId}命令请求部分复制，如果请求的偏移量不在主节点的积压缓冲区内，则无法提供给从节点数据，因此部分复制会退化为全量复制。针对这种情况需要根据网络中断时长，写命令数据量分析出合理的积压缓冲区大小。网络中断一般有闪断、机房割接、网络分区等情况。这时网络中断的时长一般在分钟级（net\_break\_time）。写命令数据量可以统计高峰期主节点每秒info replication的master\_repl\_offset差值获取（write\_size\_per\_minute）。积压缓冲区默认为1MB，对于大流量场景显然不够，这时需要增大积压缓冲区，保证 repl\_backlog\_size&gt;net\_break\_time\*write\_size\_per\_minute，从而避免因复制积 压缓冲区不足造成的全量复制。

