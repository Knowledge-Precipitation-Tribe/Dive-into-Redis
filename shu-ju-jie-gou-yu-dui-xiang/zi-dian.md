# 字典

字典是一种用于保存键值对的抽象数据结构，在字典中，一个键和一个值对应，字典中的每个键都是独一无二的，程序可以在字典中根据查找与之关联的值，或者更新与删除等操作。

字典在Redis中的应用非常广泛，比如Redis的数据库就是使用字典作为底层实现的，对数据库的增删改查都是建立在字典的操作之上的。

除了用于表示数据库之外，字典还是哈希键的底层实现之一，当一个哈希键包含的键值对比较多，或者键值对中的元素都是比阿吉哦长的字符串时，Redis就会用字典作为哈希键的底层实现。

## 字典的实现

Redis的字典使用哈希表作为底层实现，一个哈希表里可以有多个哈希表节点，而每个哈希表节点就保存在了字典中的一个键值对。

### 哈希表

![](../.gitbook/assets/image%20%28246%29.png)

table属性是一个数组，数组中的每个元素都是一个指向dictEntry结构的指针，每个dictEntry结构体都保存着一个键值对。size属性记录了哈希表的大小，也就是table数组的大小，而used属性则记录了哈希表目前已有的节点\(键值对\)数量，sizemask属性的值总是等于size-1，这个属性和哈希值一起决定一个键应该被放到table数组的哪个索引上面。

### 哈希表节点

![](../.gitbook/assets/image%20%28247%29.png)

key属性保存着键值对中的键，而v属性则保存着键值对中的值，其中键值对的值可以是一个指针，或者是一个uint64\_t整数，又或者是一个int64\_t整数**。**next属性则是指向另一个哈希表节点的指针，这个指针可以将多个哈希值相同的键值对连接在一起，一次来解决键冲突的问题。（链地址法）

![](../.gitbook/assets/image%20%28244%29.png)

### 字典

![](../.gitbook/assets/image%20%28248%29.png)

type属性和privdata属性是针对不同类型的键值对，为创建多态字典而设置的：

* type属性是一个指向dictType结构的指针，每个dictType结构保存了一簇用于操作特定类型键值对的函数，Redis会为用途不同的字典设置不同的类型特定函数
* privdata属性则保存了需要传给那些类型特定函数的可选参数

![](../.gitbook/assets/image%20%28245%29.png)

ht属性是一个包含二维数组，数组中的每一项都是dictht哈希表，一般情况下，字典只使用ht\[0\]哈希表，ht\[1\]哈希表只会在对ht\[0\]哈希表进行rehash时使用。除了ht\[1\]之外，另一个和rehash有关的属性就是rehashidx，它记录了rehash目前的进度，如果目前没有在进行rehash，那么它的值为-1。

![](../.gitbook/assets/image%20%28243%29.png)

## 哈希算法

当要将一个新的键值对添加到字典里面的时候，程序需要先根据键值对的键计算出哈希值和索引值，然后再根据索引值，将包含新键值对的哈希表节点放到哈希表数组的指定索引上面。

Redis底层使用MurmurHash2算法来计算键的哈希值。这个算法的优点在于即使输入的键是有规律的，算法仍然能给出一个很好的随机分布性，并且散发计算速度也非常快。

## 键冲突

当发生键冲突时Redis使用链地址法来解决键冲突。

## rehash

随着操作的不断执行，哈希表保存的键值对会逐渐增多或减少，为了让哈希表的负载因子维持在一个合理的范围之内，当哈希表保存的键值对数量太多或者太少时，程序需要对哈希表的大小进行相应的拓展或者收缩。



