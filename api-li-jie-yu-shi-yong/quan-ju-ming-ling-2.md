# 全局命令2

Redis提供了两个命令遍历所有的键，分别是keys和scan，本节将对它们介绍并简要分析。

### keys

要获取全部的键可以使用命令

```text
keys pattern
```

keys命令支持pattern匹配

* `*`代表匹配任意字符
* `.`代表匹配一个字符
* `[]`代表匹配部分字符，例如\[1，3\]代表匹配1，3，\[1-10\]代表匹配1到10 的任意数字
* `\x`用来做转义，例如要匹配星号、问号需要进行转义

如果Redis包含了 大量的键，执行keys命令很可能会造成Redis阻塞，所以一般建议不要在生 产环境下使用keys命令。但有时候确实有遍历键的需求该怎么办，可以在以 下三种情况使用：

* 在一个不对外提供服务的Redis从节点上执行，这样不会阻塞到客户端的请求。
* 如果确认键值总数确实比较少，可以执行该命令。
* 使用下面要介绍的scan命令渐进式的遍历所有键，可以有效防止阻塞。

### scan

Redis从2.8版本后，提供了一个新的命令scan，它能有效的解决keys命令存在的问题。和keys命令执行时会遍历所有键不同，scan采用渐进式遍历的方式来解决keys命令可能带来的阻塞问题，每次scan命令的时间复杂度是 O\(1\)，但是要真正实现keys的功能，需要执行多次scan。Redis存储键值对实际使用的是hashtable的数据结构，其简化模型如图所示。

![](../.gitbook/assets/image%20%2849%29.png)

那么每次执行scan，可以想象成只扫描一个字典中的一部分键，直到将 字典中的所有键遍历完毕。scan的使用方法如下：

```text
scan cursor [match pattern] [count number]
```

* cursor是必需参数，实际上cursor是一个游标，第一次遍历从0开始，每次scan遍历完都会返回当前游标的值，直到游标值为0，表示遍历结束。
* match pattern是可选参数，它的作用的是做模式的匹配，这点和keys的模式匹配很像。
* count number是可选参数，它的作用是表明每次要遍历的键个数，默认值是10，此参数可以适当增大。

现有一个Redis有22个键，现在要遍历所有的键，使用scan命令效果的操作如下。第一次执行scan 0，返回结果分为两个部分：第一个部分30就是下次scan需要的cursor，第二个部分是10个键：

![](../.gitbook/assets/image%20%2848%29.png)

使用新的cursor="30"，执行scan 30：

![](../.gitbook/assets/image%20%2813%29.png)

除了scan以外，Redis提供了面向哈希类型、集合类型、有序集合的扫 描遍历命令，解决诸如hgetall、smembers、zrange可能产生的阻塞问题，对 应的命令分别是hscan、sscan、zscan，它们的用法和scan基本类似。

渐进式遍历可以有效的解决keys命令可能产生的阻塞问题，但是scan并非完美无瑕，如果在scan的过程中如果有键的变化（增加、删除、修改），那么遍历效果可能会碰到如下问题：新增的键可能没有遍历到，遍历出了重复的键等情况，也就是说scan并不能保证完整的遍历出来所有的键，这些是我们在开发时需要考虑的。

